version: '3.8'

services:
  coservice:
    container_name: coservice
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8700:8700"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8700
      - ConnectionStrings__chaine=${DB_CONNECTION_STRING}
      - Consul__Enabled=${CONSUL_ENABLED:-false}
      - Consul__Address=${CONSUL_ADDRESS:-http://srv-guot-cont.gumar.local:8500}
      - Consul__ServiceName=coservice
      - Consul__ServiceId=coservice-1
      - Consul__ServiceAddress=${CONSUL_SERVICE_ADDRESS:-http://srv-guot-cont.gumar.local:8700}
      - Consul__HealthCheck__Endpoint=/sante
      - Consul__HealthCheck__Interval=10
      - Consul__HealthCheck__Timeout=5
      - RabbitMQ__Enabled=${RABBITMQ_ENABLED:-true}
      - RabbitMQ__HostName=${RABBITMQ_HOSTNAME:-192.168.2.119}
      - RabbitMQ__Port=${RABBITMQ_PORT:-5672}
      - RabbitMQ__UserName=${RABBITMQ_USERNAME:-sysadmin}
      - RabbitMQ__Password=${RABBITMQ_PASSWORD:-MyS3cur3}
      - RabbitMQ__VirtualHost=${RABBITMQ_VIRTUALHOST:-/}
      - RabbitMQ__Exchange=${RABBITMQ_EXCHANGE:-coservice}
      - ApiGateway__BaseUrl=${API_GATEWAY_BASE_URL:-http://localhost:9080}
    restart: unless-stopped
    networks:
      - coservice-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8700/sante || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  coservice-network:
    driver: bridge

